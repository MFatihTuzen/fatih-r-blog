library(NHANES)
library(dplyr)
NHANES %>%
select(ID, Age, Gender, BMI, BPSysAve, Diabetes) %>% # filter variables
glimpse() # Take a quick look at the data
library(nhanesA)
# Already created 'nhanes_small' dataset in previous step
nhanes_sub |>
summarise(
bmi_missing = mean(is.na(BMXBMI)),
income_missing = mean(is.na(INDFMPIR)),
age_missing = mean(is.na(RIDAGEYR))
)
# Count missing values for each variable
nhanes_sub %>%
summarise(across(everything(), ~ sum(is.na(.))))
library(missForest)
set.seed(123)
nhanes_imputed <- missForest(nhanes_sub)
library(missForest)
nhanes_sub <- NHANES |>
select(ID, Age, Gender, BMI, BPSysAve, Diabetes)
set.seed(123)
nhanes_imputed <- missForest(nhanes_sub)
str(nhanes_sub)
mf_input <- nhanes_sub |>
select(Age, Gender, BMI, BPSysAve, Diabetes) |>
mutate(across(where(is.character), as.factor)) |>
as.data.frame()
set.seed(123)
mf_fit <- missForest(
mf_input,
ntree   = 200,    # more trees -> stabler imputations
maxiter = 5,      # outer iterations (default 10; 5 is fine for demo)
verbose = TRUE
)
# Completed data and OOB error
mf_imputed <- mf_fit$ximp
mf_oob     <- mf_fit$OOBerror
# Quick checks
sum(is.na(mf_input$BMI));  sum(is.na(mf_imputed$BMI))   # should go to 0
sum(is.na(mf_input$BMI))
sum(is.na(mf_imputed$BMI))
mf_oob
# View first rows of the imputed dataset
head(mf_imputed$ximp)
# Check imputation error
mf_imputed$OOBerror
# View first rows of the imputed dataset
head(mf_imputed)
# Complete-case analysis (ignores missing data)
lm_cc <- lm(BMI ~ Age + Gender + BPSysAve + Diabetes,
data = nhanes_sub, na.action = na.omit)
# Single imputation (mean imputation for BMI)
nhanes_single <- nhanes_sub |>
mutate(BMI = ifelse(is.na(BMI), mean(BMI, na.rm = TRUE), BMI))
lm_si <- lm(BMI ~ Age + Gender + BPSysAve + Diabetes,
data = nhanes_single)
# Multiple imputation with mice
imp <- mice(nhanes_sub, m = 5, method = "pmm", seed = 123)
library(mice)
# Complete-case analysis (ignores missing data)
lm_cc <- lm(BMI ~ Age + Gender + BPSysAve + Diabetes,
data = nhanes_sub, na.action = na.omit)
# Single imputation (mean imputation for BMI)
nhanes_single <- nhanes_sub |>
mutate(BMI = ifelse(is.na(BMI), mean(BMI, na.rm = TRUE), BMI))
lm_si <- lm(BMI ~ Age + Gender + BPSysAve + Diabetes,
data = nhanes_single)
# Multiple imputation with mice
imp <- mice(nhanes_sub, m = 5, method = "pmm", seed = 123)
lm_mi <- with(imp, lm(BMI ~ Age + Gender + BPSysAve + Diabetes))
pooled <- pool(lm_mi)
summary(lm_cc)
summary(lm_si)
summary(pooled)
library(palmerpenguins)
library(dplyr)
data(penguins)
Q1 <- quantile(penguins$body_mass_g, 0.25, na.rm = TRUE)
Q3 <- quantile(penguins$body_mass_g, 0.75, na.rm = TRUE)
IQR_value <- Q3 - Q1
penguins_iqr <- penguins %>%
mutate(
outlier_iqr =
body_mass_g < Q1 - 1.5 * IQR_value |
body_mass_g > Q3 + 1.5 * IQR_value
)
penguins_iqr
View(penguins_iqr)
View(penguins)
boxplot(
penguins$bill_length_mm,
main = "Body Mass Distribution",
ylab = "Body mass (g)"
)
boxplot(
penguins$bill_depth_mm,
main = "Body Mass Distribution",
ylab = "Body mass (g)"
)
boxplot(
penguins$flipper_length_mm,
main = "Body Mass Distribution",
ylab = "Body mass (g)"
)
airquality
boxplot(
airquality$Ozone,
main = "Body Mass Distribution",
ylab = "Body mass (g)"
)
boxplot(
airquality$Solar.R,
main = "Body Mass Distribution",
ylab = "Body mass (g)"
)
boxplot(
airquality$Wind,
main = "Body Mass Distribution",
ylab = "Body mass (g)"
)
boxplot(
airquality$Temp,
main = "Body Mass Distribution",
ylab = "Body mass (g)"
)
boxplot(
airquality$Wind,
main = "Body Mass Distribution",
ylab = "Body mass (g)"
)
# Example URL (Istanbul). You can get the latest link from Inside Airbnb "Get the Data".
# The URL structure typically follows:
# https://data.insideairbnb.com/<country>/<region>/<city>/<date>/data/listings.csv.gz
url_listings <- "https://data.insideairbnb.com/turkey/marmara/istanbul/2023-06-29/data/listings.csv.gz"
listings_raw <- read_csv(url_listings, show_col_types = FALSE)
library(readr)
listings_raw <- read_csv(url_listings, show_col_types = FALSE)
listings_raw <- read.csv(url_listings, show_col_types = FALSE)
listings_raw <- read.csv(url_listings)
listings_raw <- read_csv(url_listings, show_col_types = FALSE)
getwd()
listings_raw <- read_csv(
"data/listings.csv.gz",
show_col_types = FALSE
)
listings_raw <- read_csv(
"./data/listings.csv.gz",
show_col_types = FALSE
)
listings_raw <- read_csv(
"./data/listings.csv.gz",
show_col_types = FALSE
)
listings_raw <- read_csv(
"listings.csv.gz",
show_col_types = FALSE
)
View(listings_raw)
glimpse(listings_raw)
xx <- read.csv("https://data.insideairbnb.com/turkey/marmara/istanbul/2025-09-29/data/listings.csv.gz")
xx <- read_csv("https://data.insideairbnb.com/turkey/marmara/istanbul/2025-09-29/data/listings.csv.gz")
getwd()
str(listings_raw$price)
vars_keep <- c(
"id", "name",
"price", "minimum_nights", "number_of_reviews",
"room_type", "neighbourhood_cleansed"
)
listings_small <- listings_raw %>%
select(any_of(vars_keep)) %>%
mutate(
price_num = price %>%
str_replace_all("[^0-9.]", "") %>%
as.numeric()
)
library(stringr)
listings_small <- listings_raw %>%
select(any_of(vars_keep)) %>%
mutate(
price_num = price %>%
str_replace_all("[^0-9.]", "") %>%
as.numeric()
)
View(listings_small)
str(listings_small)
glimpse(listings_small)
listings_small <- listings_raw %>%
select(any_of(vars_keep))
glimpse(listings_small)
listings_small <- listings_small %>%
mutate(price_num = price %>%
str_replace_all("[^0-9.]", "") %>%
as.numeric())
summary(listings_small$price_num)
hist(
listings_small$price_num,
breaks = 50,
main = "Distribution of Nightly Prices",
xlab = "Nightly price",
col = "lightgray",
border = "white"
)
price_99 <- quantile(listings_small$price_num, 0.99, na.rm = TRUE)
hist(
listings_small$price_num[listings_small$price_num <= price_99],
breaks = 40,
main = "Distribution of Nightly Prices (Up to 99th Percentile)",
xlab = "Nightly price",
col = "#4C72B0",
border = "white"
)
# Eğer daha önce yapmadıysan:
listings_small <- listings_raw %>%
select(any_of(c("id","name","price","room_type","neighbourhood_cleansed",
"minimum_nights","number_of_reviews"))) %>%
mutate(
price_num = price %>%
str_replace_all("[^0-9.]", "") %>%
as.numeric()
) %>%
filter(!is.na(price_num), price_num > 0, !is.na(room_type))
# Bilimsel gösterimi (1e+06) istemiyoruz:
# ggplot'ta bu işi scales ile zaten çözeceğiz.
#
# p1 <- ggplot(listings_small, aes(x = price_num)) +
geom_histogram(bins = 40, alpha = 0.85) +
scale_x_log10(
labels = label_number(big.mark = ","),
breaks = trans_breaks("log10", function(x) 10^x)
) +
facet_wrap(~ room_type, scales = "free_y") +
labs(
title = "Nightly Price Distribution by Room Type (log scale)",
subtitle = "Log scale makes the long right tail interpretable without hiding extreme values",
x = "Nightly price (log10 scale)",
y = "Count"
) +
theme_minimal(base_size = 13)
library(ggplot2)
# Bilimsel gösterimi (1e+06) istemiyoruz:
# ggplot'ta bu işi scales ile zaten çözeceğiz.
#
# p1 <- ggplot(listings_small, aes(x = price_num)) +
geom_histogram(bins = 40, alpha = 0.85) +
scale_x_log10(
labels = label_number(big.mark = ","),
breaks = trans_breaks("log10", function(x) 10^x)
) +
facet_wrap(~ room_type, scales = "free_y") +
labs(
title = "Nightly Price Distribution by Room Type (log scale)",
subtitle = "Log scale makes the long right tail interpretable without hiding extreme values",
x = "Nightly price (log10 scale)",
y = "Count"
) +
theme_minimal(base_size = 13)
p2 <- ggplot(listings_small, aes(x = room_type, y = price_num)) +
geom_boxplot(outlier_alpha = 0.35) +
scale_y_log10(labels = label_number(big.mark = ",")) +
labs(
title = "Nightly Prices by Room Type (boxplot, log scale)",
subtitle = "Outliers are assessed within each room type rather than globally",
x = "Room type",
y = "Nightly price (log10 scale)"
) +
theme_minimal(base_size = 13) +
theme(axis.text.x = element_text(angle = 20, hjust = 1))
p2
p2 <- ggplot(listings_small, aes(x = room_type, y = price_num)) +
geom_boxplot(outlier_alpha = 0.35) +
scale_y_log10(labels = label_number(big.mark = ",")) +
labs(
title = "Nightly Prices by Room Type (boxplot, log scale)",
subtitle = "Outliers are assessed within each room type rather than globally",
x = "Room type",
y = "Nightly price (log10 scale)"
) +
theme_minimal(base_size = 13) +
theme(axis.text.x = element_text(angle = 20, hjust = 1))
p3 <- ggplot(listings_small, aes(x = price_num, y = room_type)) +
geom_density_ridges(scale = 1.2, alpha = 0.85) +
scale_x_log10(labels = label_number(big.mark = ",")) +
labs(
title = "Price Distributions by Room Type (ridgeline, log scale)",
x = "Nightly price (log10 scale)",
y = "Room type"
) +
theme_minimal(base_size = 13)
library(ggridges)
p3 <- ggplot(listings_small, aes(x = price_num, y = room_type)) +
geom_density_ridges(scale = 1.2, alpha = 0.85) +
scale_x_log10(labels = label_number(big.mark = ",")) +
labs(
title = "Price Distributions by Room Type (ridgeline, log scale)",
x = "Nightly price (log10 scale)",
y = "Room type"
) +
theme_minimal(base_size = 13)
library(ggplot2)
library(scales)
ggplot(listings_small, aes(x = price_num)) +
geom_histogram(bins = 40, fill = "#B0B0B0", color = "white") +
scale_x_continuous(labels = label_number(big.mark = ",")) +
labs(
title = "Distribution of Nightly Prices (raw scale)",
x = "Nightly price",
y = "Count"
) +
theme_minimal(base_size = 13)
listings_small <- listings_small %>%
mutate(price_num = price %>%
str_replace_all("[^0-9.]", "") %>%
as.numeric())
ggplot(listings_small, aes(x = price_num)) +
geom_histogram(bins = 40, fill = "#B0B0B0", color = "white") +
scale_x_continuous(labels = label_number(big.mark = ",")) +
labs(
title = "Distribution of Nightly Prices (raw scale)",
x = "Nightly price",
y = "Count"
) +
theme_minimal(base_size = 13)
listings_small %>%
count(room_type, sort = TRUE)
ggplot(listings_small, aes(x = price_num)) +
geom_histogram(bins = 35, fill = "#4C72B0", color = "white", alpha = 0.9) +
scale_x_log10(
breaks = log_breaks(n = 6),
labels = label_number(big.mark = ",")
) +
facet_wrap(~ room_type, scales = "free_y") +
labs(
title = "Nightly Price Distributions by Room Type (log scale)",
subtitle = "Log scale improves readability in heavily right-skewed price data",
x = "Nightly price (log scale)",
y = "Count"
) +
theme_minimal(base_size = 13)
listings_small %>%
count(room_type, sort = TRUE)
ggplot(listings_small, aes(x = price_num)) +
geom_histogram(bins = 35, fill = "#4C72B0", color = "white", alpha = 0.9) +
scale_x_log10(
breaks = log_breaks(n = 6),
labels = label_number(big.mark = ",")
) +
facet_wrap(~ room_type, scales = "free_y") +
labs(
title = "Nightly Price Distributions by Room Type (log scale)",
subtitle = "Log scale improves readability in heavily right-skewed price data",
x = "Nightly price (log scale)",
y = "Count"
) +
theme_minimal(base_size = 13)
ggplot(listings_small, aes(x = room_type, y = price_num)) +
geom_boxplot(outlier.alpha = 0.35, fill = "#DDDDDD") +
scale_y_log10(labels = label_number(big.mark = ",")) +
labs(
title = "Nightly Prices by Room Type (boxplot, log scale)",
subtitle = "Potential outliers are assessed within each room type",
x = "Room type",
y = "Nightly price (log scale)"
) +
theme_minimal(base_size = 13) +
theme(axis.text.x = element_text(angle = 20, hjust = 1))
outliers_iqr <- listings_small %>%
group_by(room_type) %>%
mutate(
Q1 = quantile(price_num, 0.25, na.rm = TRUE),
Q3 = quantile(price_num, 0.75, na.rm = TRUE),
IQR_value = Q3 - Q1,
lower_bound = Q1 - 1.5 * IQR_value,
upper_bound = Q3 + 1.5 * IQR_value,
outlier_iqr = price_num < lower_bound | price_num > upper_bound
) %>%
ungroup()
outliers_iqr
View(outliers_iqr)
outliers_iqr %>%
count(room_type, outlier_iqr) %>%
arrange(room_type, desc(outlier_iqr))
top_price_outliers <- outliers_iqr %>%
filter(outlier_iqr) %>%
group_by(room_type) %>%
arrange(desc(price_num)) %>%
slice_head(n = 5) %>%
ungroup() %>%
select(
room_type,
price,
price_num,
minimum_nights,
number_of_reviews,
neighbourhood_cleansed,
name
)
top_price_outliers
outliers_z <- listings_small %>%
group_by(room_type) %>%
mutate(
mean_price = mean(price_num, na.rm = TRUE),
sd_price   = sd(price_num, na.rm = TRUE),
z_price    = (price_num - mean_price) / sd_price,
outlier_z  = abs(z_price) > 3
) %>%
ungroup()
outliers_z %>%
count(room_type, outlier_z) %>%
arrange(room_type, desc(outlier_z))
top_z_outliers <- outliers_z %>%
filter(outlier_z) %>%
group_by(room_type) %>%
arrange(desc(abs(z_price))) %>%
slice_head(n = 5) %>%
ungroup() %>%
select(
room_type,
price,
price_num,
z_price,
minimum_nights,
number_of_reviews,
neighbourhood_cleansed,
name
)
top_z_outliers
top_z_outliers <- outliers_z %>%
filter(outlier_z) %>%
group_by(room_type) %>%
arrange(desc(abs(z_price))) %>%
slice_head(n = 5) %>%
ungroup() %>%
select(
room_type,
price,
price_num,
z_price,
minimum_nights,
number_of_reviews,
neighbourhood_cleansed,
name
)
top_z_outliers
#### Comparing IQR and Z-score results
Finally, we compare how many listings are flagged by each method.
comparison_summary <- outliers_iqr %>%
select(id, room_type, outlier_iqr) %>%
left_join(
outliers_z %>% select(id, outlier_z),
by = "id"
) %>%
count(outlier_iqr, outlier_z)
comparison_summary
